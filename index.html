<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Telegram Web App Validation</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
        }

        #result {
            text-align: center;
            margin-top: 20px;
        }

        #pointsSection {
            margin-top: 20px;
            text-align: center;
        }

        #addPoints {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
        }

        #addPoints:disabled {
            background-color: gray;
            cursor: not-allowed;
        }

        #timer {
            font-size: 24px;
            margin-top: 10px;
            color: yellow;
        }
    </style>
</head>
<body>
    <h1>Telegram Web App Validation</h1>
    <div id="result">Loading...</div>

    <div id="pointsSection">
        <!-- Кнопка для добавления очков -->
        <button id="addPoints">Get 100 Points</button>
        <div id="timer" style="display:none;"></div> <!-- Таймер скрыт по умолчанию -->
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const initData = tg.initData;

        console.log("Init Data:", initData);

        const serverUrl = 'https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com'; // Ваш серверный URL

        // Получаем данные с сервера для валидации
        fetch(`${serverUrl}/validate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ initData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('result').innerText = `Validation Successful! Welcome, ${data.username}`;

                const userId = data.user_id;
                const lastClickTime = data.last_click_time; // время последнего клика
                updatePoints(data.points);

                // Обработчик нажатия на кнопку
                document.getElementById('addPoints').addEventListener('click', function() {
                    fetch(`${serverUrl}/add_points`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updatePoints(data.points);
                            startTimer(data.last_click_time); // Обновляем таймер после клика
                        } else {
                            alert(data.message);
                        }
                    });
                });

                // Обновление информации о баллах и таймере
                function updatePoints(newPoints) {
                    document.getElementById('pointsSection').innerHTML = `
                        <div>
                            <h2>Current Points: ${newPoints}</h2>
                            <button id="addPoints">Get 100 Points</button>
                            <div id="timer" style="display:none;"></div> <!-- Таймер скрыт по умолчанию -->
                        </div>
                    `;
                    startTimer(lastClickTime); // Запускаем таймер при обновлении
                }

                // Запуск таймера для отображения времени
                function startTimer(lastClickTime) {
                    const currentTime = Math.floor(Date.now() / 1000); // Текущее время в секундах
                    const timeLeft = 60 - (currentTime - lastClickTime); // Время до следующего клика

                    const addPointsButton = document.getElementById('addPoints');
                    const timerDiv = document.getElementById('timer');

                    if (timeLeft > 0) {
                        // Если время не прошло, скрываем кнопку и показываем таймер
                        addPointsButton.style.display = "none";  // Скрыть кнопку
                        timerDiv.style.display = "block"; // Показать таймер
                        timerDiv.innerText = `Please wait ${timeLeft} seconds.`;

                        // Обновляем таймер каждую секунду
                        const timerInterval = setInterval(() => {
                            const remainingTime = timeLeft - Math.floor(Date.now() / 1000) + currentTime;
                            if (remainingTime <= 0) {
                                clearInterval(timerInterval);
                                addPointsButton.style.display = "block"; // Показать кнопку
                                timerDiv.style.display = "none"; // Скрыть таймер
                                localStorage.removeItem('lastClickTime');
                                localStorage.removeItem('timeLeft');
                            } else {
                                timerDiv.innerText = `Please wait ${remainingTime} seconds.`;
                            }
                        }, 1000);
                    } else {
                        // Если время прошло, показываем кнопку и скрываем таймер
                        addPointsButton.style.display = "block";  // Показать кнопку
                        timerDiv.style.display = "none"; // Скрыть таймер
                    }
                }
            }
        });
    </script>
</body>
</html>
