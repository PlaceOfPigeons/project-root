<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Telegram Web App Validation</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
        }

        #result {
            text-align: center;
            margin-top: 20px;
        }

        #pointsSection {
            margin-top: 20px;
            text-align: center;
        }

        #addPoints, #subtractPoints {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
        }

        #subtractPoints {
            background-color: red;
        }
    </style>
</head>
<body>
    <h1>Telegram Web App Validation</h1>
    <div id="result">Loading...</div>

    <div id="pointsSection">
        <button id="addPoints">Add 100 Points</button>
        <div>
            <input type="text" id="productId" placeholder="Enter Product ID to subtract" />
            <button id="subtractPoints">Subtract 100 Points</button>
        </div>
    </div>

    <script>
        // Получаем объект Telegram Web App
        const tg = window.Telegram.WebApp;
        const initData = tg.initData;

        // Отображаем исходные данные
        console.log("Init Data:", initData);

        const serverUrl = 'https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com'; // URL вашего сервера

        // Отправка данных на сервер для валидации
        fetch(`${serverUrl}/validate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ initData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('result').innerText = `Validation Successful! Welcome, ${data.username}`;
                
                // Сохраняем user_id для использования при добавлении или вычитании очков
                const userId = data.user_id;
                let points = data.points;

                // Обновляем UI для отображения очков
                updatePoints(points);

                // Обработчик для добавления 100 очков
                document.getElementById('addPoints').addEventListener('click', function() {
                    fetch(`${serverUrl}/add_points`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            points = data.points;
                            updatePoints(points);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("An error occurred while adding points.");
                    });
                });

                // Обработчик для вычитания 100 очков
                document.getElementById('subtractPoints').addEventListener('click', function() {
                    const productId = document.getElementById('productId').value;

                    if (!productId) {
                        alert("Please enter a product ID.");
                        return;
                    }

                    fetch(`${serverUrl}/subtract_points`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId, productId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            points = data.points;
                            updatePoints(points);
                            alert(data.message);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("An error occurred while subtracting points.");
                    });
                });

                // Функция для обновления отображаемых очков
                function updatePoints(newPoints) {
                    document.getElementById('pointsSection').innerHTML = `
                        <div>
                            <h2>Current Points: ${newPoints}</h2>
                            <button id="addPoints">Add 100 Points</button>
                            <div>
                                <input type="text" id="productId" placeholder="Enter Product ID to subtract" />
                                <button id="subtractPoints">Subtract 100 Points</button>
                            </div>
                        </div>
                    `;
                }
            } else {
                document.getElementById('result').innerText = "Validation Failed.";
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('result').innerText = "An error occurred.";
        });
    </script>
</body>
</html>
