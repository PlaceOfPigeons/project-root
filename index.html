<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Telegram Web App Validation</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
        }

        #result {
            text-align: center;
            margin-top: 20px;
        }

        #pointsSection {
            margin-top: 20px;
            text-align: center;
        }

        #addPoints {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            cursor: pointer;
        }

        #addPoints:disabled {
            background-color: gray;
            cursor: not-allowed;
        }

        #timer {
            font-size: 24px;
            margin-top: 10px;
            color: yellow;
        }

    </style>
</head>
<body>
    <h1>Telegram Web App Validation</h1>
    <div id="result">Loading...</div>

    <div id="pointsSection">
        <button id="addPoints">Add 100 Points</button>
        <div id="timer">Please wait...</div>
    </div>

    <script>
        // Получаем объект Telegram Web App
        const tg = window.Telegram.WebApp;
        const initData = tg.initData;

        // Отображаем исходные данные
        console.log("Init Data:", initData);

        const serverUrl = 'https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com'; // URL вашего сервера

        // Отправка данных на сервер для валидации
        fetch(`${serverUrl}/validate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ initData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('result').innerText = `Validation Successful! Welcome, ${data.username}`;
                
                // Сохраняем user_id для использования при добавлении очков
                const userId = data.user_id;
                let points = data.points;
                let lastClickTime = data.last_click_time;
                
                // Обновляем UI для отображения очков
                updatePoints(points);

                // Обработчик для добавления 100 очков
                document.getElementById('addPoints').addEventListener('click', function() {
                    fetch(`${serverUrl}/add_points`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ userId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            points = data.points;
                            lastClickTime = data.last_click_time;  // Обновляем время последнего клика
                            updatePoints(points);
                            startTimer(lastClickTime); // Перезапускаем таймер
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("An error occurred while adding points.");
                    });
                });

                // Функция для обновления отображаемых очков
                function updatePoints(newPoints) {
                    document.getElementById('pointsSection').innerHTML = `
                        <div>
                            <h2>Current Points: ${newPoints}</h2>
                            <button id="addPoints">Add 100 Points</button>
                            <div id="timer">Please wait...</div>
                        </div>
                    `;
                    startTimer(lastClickTime); // Запуск таймера
                }

                // Функция для старта таймера
                function startTimer(lastClickTime) {
                    const currentTime = Math.floor(Date.now() / 1000); // Текущее время в секундах
                    const timeLeft = 60 - (currentTime - lastClickTime); // Время до следующего клика

                    if (timeLeft > 0) {
                        // Деактивируем кнопку и показываем таймер
                        document.getElementById('addPoints').disabled = true;
                        document.getElementById('timer').innerText = `Please wait ${timeLeft} seconds.`;

                        // Обновляем таймер каждую секунду
                        const timerInterval = setInterval(() => {
                            const remainingTime = timeLeft - Math.floor(Date.now() / 1000) + currentTime;
                            if (remainingTime <= 0) {
                                clearInterval(timerInterval);
                                document.getElementById('addPoints').disabled = false;
                                document.getElementById('timer').innerText = 'You can now click the button again!';
                            } else {
                                document.getElementById('timer').innerText = `Please wait ${remainingTime} seconds.`;
                            }
                        }, 1000);
                    } else {
                        // Если прошло достаточно времени, включаем кнопку
                        document.getElementById('addPoints').disabled = false;
                        document.getElementById('timer').innerText = 'You can now click the button again!';
                    }
                }

            } else {
                document.getElementById('result').innerText = "Validation Failed.";
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('result').innerText = "An error occurred.";
        });
    </script>
</body>
</html>
