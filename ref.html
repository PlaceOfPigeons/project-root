<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Web App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="username"></div>
  <div id="referrals"></div> <!-- Здесь будут отображаться рефералы -->

  <script>
    // Функция для получения данных о рефералах с сервера
    async function getReferrals(userId) {
      console.log("Запрос на сервер для userId:", userId);  // Логируем userId
      try {
        const response = await fetch(`https://frozen-dawn-48680-9cdb4d5a9403.herokuapp.com/get_referrals?user_id=${userId}`);
        
        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Полученные данные о рефералах:", data);  // Логируем ответ

        if (data.referrals) {
          displayReferrals(data.referrals);
        } else {
          console.error("Ошибка получения данных о рефералах:", data.error);
          document.getElementById('referrals').textContent = "Не удалось получить рефералов.";
        }
      } catch (error) {
        console.error("Ошибка запроса к серверу:", error);
        document.getElementById('referrals').textContent = "Ошибка запроса: " + error.message;
      }
    }

    // Функция для отображения данных о рефералах
    function displayReferrals(referrals) {
      const referralsElement = document.getElementById('referrals');
      if (referrals.length > 0) {
        referralsElement.innerHTML = "Рефералы: " + referrals.join(', ');
      } else {
        referralsElement.innerHTML = "Нет рефералов.";
      }
    }

    // Инициализация Telegram Web App
    const tg = window.Telegram.WebApp;

    // Применяем режим полного экрана для мини-приложения
    window.Telegram.WebApp.expand();
    window.Telegram.WebApp.requestFullscreen();

    // Убедитесь, что Web App готов
    tg.ready();

    // Получение данных о пользователе
    const user = tg.initDataUnsafe?.user || {};
    console.log("Данные о пользователе:", user);  // Логируем данные о пользователе

    if (user && user.id) {
      const userId = user.id;  // Получаем ID пользователя
      const usernameElement = document.getElementById('username');
      if (usernameElement) {
        usernameElement.textContent = `Привет, ${user.first_name}!`;
      }
      
      // Получение данных о рефералах
      getReferrals(userId);
    } else {
      console.error("Не удалось получить данные о пользователе.");
      document.getElementById('username').textContent = "Не удалось получить данные о пользователе.";
    }
  </script>
</body>
</html>
